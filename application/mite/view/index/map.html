<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" name="viewport">
	<title>
	    小虫
	</title>
	<link href="__PUBLIC__/css/liuliuIndex.css" rel="stylesheet" type="text/css"/>
	<style type="text/css">
		#container{
			width: 100vw;
			height: 100vh;
			position: relative;
		}
		*{
			margin: 0;
		}
		.anchorBL{
			display: none;
		}
		.back{
			width: 48px;
			height: 48px;
			top: 10px;
			left: 10px;
		}
.loadComunity {
	display: block;
	position: absolute;
	white-space: nowrap;
	z-index: 10;
}
.loadComunity .box {
	border-radius: 8px;
	text-align: center;
	font-size: 14px;
	font-weight: bold;
	background-color: #D98E45;
	background-size: contain;
	color: #fff;
	box-shadow: 0 2px 2px rgba(0,0,0,0.2);
}
.loadComunity .box .name {
	white-space: nowrap;
	padding: 6px 6px 5px 8px;
	display: flex;
	flex-direction: row;
	justify-content: center;
}
.loadComunity .box span {
    text-overflow: ellipsis;
    overflow: hidden;
}
.loadComunity .room-count {
    min-width: 20px;
    margin-left: 3px;
    color: #424242;
    font-size: 14px;
}
.jiantou:after {
	content: "";
    position: absolute;
    left: 10px;
	width: 0;
	height: 0;
	border-left: 8px solid transparent;
	border-right: 8px solid transparent;
	border-top: 6px solid #D98E45;
}
.allmap_SearchCtrl {
	position: absolute;
	top: 10px;
	left: 70px;
	right: 13px;
	overflow: hidden;
	box-shadow: 0 1px 2px 0 rgba(0,0,0,0.17), 0 1px 4px 0 rgba(0,0,0,0.12);
}
.allmap_SearchCtrl .box {
    height: 48px;
    background-color: #fff;
    box-shadow: 0 1px 2px 0 rgba(0,0,0,0.17), 0 1px 4px 0 rgba(0,0,0,0.12);
    border-radius: 3px;
}
.allmap_SearchCtrl span.input_wrap {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    transition: right ease-out .1s;
    -webkit-transition: right ease-out .1s;
    overflow-y: hidden;
}
.input_wrap img{
	margin-top: 10px;
	margin-left: 10px;
	width: 28px;
	height: 28px;
}
input.allmap_SearchInput {
    margin-top: 4px;
    float: right;
    width: 80%;
    height: 32px;
    line-height: normal;
    text-align: center;
    font-size: 17px;
    padding: 6px 0;
    border: 0 none;
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    -webkit-tap-highlight-color: transparent;
    color: #22264a;
    border-radius: 10px;
}
	</style>
</head>
<body>
	<div id="container"></div>
	<div class="back" id="backBtn"></div>
	<div class="allmap_SearchCtrl">
        <div class="box">
            <span class="input_wrap">
            	<img src="__PUBLIC__/image/search.png" alt="">
            	<input id="memo" class="allmap_SearchInput" placeholder="请输入小区名" type="text" name="memo" size=60/>
            </span>
        </div>
    </div>
	
	<script src="__PUBLIC__/js/jquery/jquery-3.1.0.min.js"></script>
	<script src="__PUBLIC__/js/liuliucommon.js"></script>
	<script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=BFXj0c60XOW3UUKDlL3nM0i9XPcq72qe&s=1"></script>
	<script type="text/javascript">

		
		window.onload = function (){
			// 百度地图API功能
			var map = new BMap.Map("container"); // 创建地图实例
			var point = new BMap.Point({$housedetail['longitude']|default="113.27082"}, {$housedetail['latitude']|default="23.133641"}); // 创建点坐标
			// map.centerAndZoom("成都", 13); // 初始化地图，设置中心点坐标和地图级别
			map.centerAndZoom("广州", 7);
			map.enableScrollWheelZoom();

			var coder = new BMap.Geocoder();

			var memo = document.getElementById("memo");

			memo.addEventListener("change",findaddr);

			function findaddr(e) {

				var str = memo.value;
				var city = "广州";
				coder.getPoint(str, bingo, city);
				e.preventDefault(); 
			}

			function bingo(data) {
				console.log(data);
				if (data) {
					map.setCenter(data);
					map.setZoom(14);
				}
			}

			// // 定义一个控件类，即function    
			// function ZoomControl(){    
			//     // 设置默认停靠位置和偏移量  
			//     this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;    
			//     this.defaultOffset = new BMap.Size(10, 10);    
			// }    
			// // 通过JavaScript的prototype属性继承于BMap.Control   
			// ZoomControl.prototype = new BMap.Control();
			// // 自定义控件必须实现initialize方法，并且将控件的DOM元素返回   
			// // 在本方法中创建个div元素作为控件的容器，并将其添加到地图容器中   
			// ZoomControl.prototype.initialize = function(map){    
			//     // 创建一个DOM元素   
			//     var div = document.createElement("div");    
			//     // 添加文字说明    
			//     div.appendChild(document.createTextNode("放大2级"));    
			//     // 设置样式    
			//     div.style.cursor = "pointer";    
			//     div.style.border = "1px solid gray";    
			//     div.style.backgroundColor = "white";    
			//     // 绑定事件，点击一次放大两级    
			//     div.onclick = function(e){ 
			//     console.log("asd"); 
			//         map.zoomTo(map.getZoom() + 2);    
			//     }    
			//     // 添加DOM元素到地图中   
			//     map.getContainer().appendChild(div);    
			//     // 将DOM元素返回  
			//     return div;    
			//  }
			// // 创建控件实例    
			// var myZoomCtrl = new ZoomControl();    
			// // 添加到地图当中    
			// map.addControl(myZoomCtrl);







			map.addControl(new BMap.NavigationControl()); //添加默认缩放平移控件
			// map.addControl(new BMap.ScaleControl()); //比例尺
			//map.addControl(new BMap.OverviewMapControl()); //缩略图
			//map.addControl(new BMap.MapTypeControl()); //地图类型
			//自定义图标
			// var myIcon = new BMap.Icon("__PUBLIC__/image/icon/noimg.png", new BMap.Size(20,20));
			// var marker = new BMap.Marker(point,{icon:myIcon});
			// var marker = new BMap.Marker(point);
			// marker.enableDragging();
			// map.addOverlay(marker);








			// ========================
            // 楼盘覆盖物
            function ComunityOverlay(options) {
                this.o = {
                    Id: '',
                    Name: '',
                    Lng: '',
                    Lat: '',
                    Address: "",
                    MinRental: "",
                    MaxRental: "",
                    RoomCount: ''
                }

                for (var i in options) {
                    this.o[i] = options[i];
                }
            }

            ComunityOverlay.prototype = new BMap.Overlay();

            ComunityOverlay.prototype.initialize = function (map) {
                this._map = map;
                var wrapDiv = this._wrapDiv = document.createElement("div");
                $(wrapDiv).attr("class", "loadComunity");
                wrapDiv.style.position = "absolute";
                wrapDiv.setAttribute("data-load-lng", this.o.Lng);
                wrapDiv.setAttribute("data-load-lat", this.o.Lat);

                var box = document.createElement("div");
                box.setAttribute('class', 'box');

                var name = document.createElement("div");
                name.setAttribute('class', 'name');

                var span1 = document.createElement("span");
                span1.appendChild(document.createTextNode(this.o.Name));

                var span2 = document.createElement("span");
                span2.appendChild(document.createTextNode(this.o.RoomCount));
                span2.setAttribute('class', 'room-count');

                name.appendChild(span1);
                name.appendChild(span2);


                var jiantou = document.createElement("div");
                jiantou.setAttribute('class', 'jiantou iconfont icon-shape');

                box.appendChild(name);
                box.appendChild(jiantou);
                wrapDiv.appendChild(box);

                map.getPanes().labelPane.appendChild(wrapDiv);
                return wrapDiv;
            }

            ComunityOverlay.prototype.draw = function () {
                var point = new BMap.Point(this.o.Lng, this.o.Lat);
                var position = this._map.pointToOverlayPixel(point);
                var offsetLeft = this._wrapDiv.offsetWidth / 2;

                this._wrapDiv.style.left = position.x - offsetLeft + "px";
                this._wrapDiv.style.top = position.y - 53 + "px";
            }


            
			



var a = [
	{
        Id: '1',
        Name: '测试1',
        Lng: '113',
        Lat: '23',
        Address: "阿斯顿",
        MinRental: "123",
        MaxRental: "12",
        RoomCount: '1'
    },
    {
        Id: '2',
        Name: '测试2',
        Lng: '115',
        Lat: '24',
        Address: "阿斯顿",
        MinRental: "123",
        MaxRental: "12",
        RoomCount: '4'
    },
    {
        Id: '3',
        Name: '测试3测试3测试3测试3测试3测试3',
        Lng: '116',
        Lat: '22',
        Address: "阿斯顿",
        MinRental: "123",
        MaxRental: "12",
        RoomCount: '1'
    },
    {
        Id: '4',
        Name: '测试4',
        Lng: '113',
        Lat: '20',
        Address: "阿斯顿",
        MinRental: "123",
        MaxRental: "12",
        RoomCount: '1'
    },
    {
        Id: '5',
        Name: '测试5',
        Lng: '112',
        Lat: '22',
        Address: "阿斯顿",
        MinRental: "123",
        MaxRental: "12",
        RoomCount: '1'
    }
];

			for(var i = 0 ; i <= a.length-1 ; i++){
				// var point = new BMap.Point(100 + 16.133641 * (Math.random() * 0.7), 23 + 20 * (Math.random() * 0.7));
				// // console.log(point);
				// // point.enableDragging();
				// // map.addOverlay(point);
				// var marker = new BMap.Marker(point);
	  	// 		map.addOverlay(marker);


	  			var comunityOverlay = new ComunityOverlay(a[i]);
				map.addOverlay(comunityOverlay);
			}

			coder = new BMap.Geocoder();

			// // 创建控件实例    
			// var myZoomCtrl = new ZoomControl();
			// // 添加到地图当中    
			// map.addControl(myZoomCtrl);
			 
			var customLayer;
			// marker = new BMap.Marker(point);
			// marker.enableDragging();
			// map.addOverlay(marker);
			// marker.addEventListener("dragend", function (e) {
			//     setpoint(e.point, 1);
			// });
			 
			map.addEventListener('click', function (e) {
			    // setpoint(e.point, 2);
			    console.log(e.point);
			});


			var zoomIn = document.getElementsByClassName('BMap_stdMpZoomIn');
			var zoomOut = document.getElementsByClassName('BMap_stdMpZoomOut');
			console.log(zoomIn);
			// zoomIn[0].addEventListener("click",function(e) {
			// 	console.log("asd");
			// });
			 
			var touchStart = null;
			var touchMove = false;
			map.addEventListener("touchstart", function (e) {
			    touchStart = e.pixel;
			    touchMove = false;
			});
			map.addEventListener("touchend", function (e) {
				// console.log(e);
				// deletePoint();
				
			    // if (Math.abs(touchStart.x - e.pixel.x) <= 10 && Math.abs(touchStart.y - e.pixel.y) <= 10) setpoint(e.point, 3);
			});

			function setpoint(p, t) {
				longitude = p.lng;
				latitude = p.lat;
				
			    point.lng = p.lng;
			    point.lat = p.lat;
			 
			    // marker.setPosition(point);
			    map.setCenter(point);
			    /*
			    map.removeOverlay(marker);
			    marker.point = point;
			    map.addOverlay(marker);
			*/
			    //alert(point.lng + "," + point.lat + ":" + t);
			    //coder.getLocation(point, echovalue);
			}

			function deletePoint(){
				var allOverlay = map.getOverlays();
				for(var j = 0 ; j <= allOverlay.length-3 ; j++){
					map.removeOverlay(allOverlay[j]);
				}
			}
		}

	</script>
<script type="text/javascript">
		 // // 百度地图API
   //      var map = new BMap.Map("allmap", { minZoom: 10, maxZoom: 16 });  // 创建Map实例

   //      map.addEventListener("load", function () {
   //          var zoom_btn_in = $(".zoom_btn_in"),
   //              zoom_btn_out = $(".zoom_btn_out"),
   //              zoom = map.getZoom();

   //          // 添加地图缩放控件
   //          function ZoomControl() {
   //              this.defaultAnchor = BMAP_ANCHOR_TOP_LEFT;
   //              this.defaultOffset = new BMap.Size(10, 10);
   //          }

   //          function listenZoomCtrlChange() {
   //              switch (zoom) {
   //                  case 10:
   //                      zoom_btn_in.children().css({ "opacity": 1 });
   //                      zoom_btn_out.children().css({ "opacity": .5 });
   //                      break;
   //                  case 16:
   //                      zoom_btn_in.children().css({ "opacity": .5 });
   //                      zoom_btn_out.children().css({ "opacity": 1 });
   //                      break;
   //                  default:
   //                      zoom_btn_in.children().css({ "opacity": 1 });
   //                      zoom_btn_out.children().css({ "opacity": 1 });
   //                      break;
   //              }
   //          }

   //          ZoomControl.prototype = new BMap.Control();
   //          ZoomControl.prototype.initialize = function (map) {
   //              zoom = map.getZoom();

   //              listenZoomCtrlChange();

   //              zoom_btn_in[0].onclick = function (e) {
   //                  zoom = map.getZoom();
   //                  map.setZoom(zoom + 1);

   //                  if (zoom > 14) {
   //                      zoom_btn_in.children().css({ "opacity": .5 });
   //                  } else {
   //                      zoom_btn_in.children().css({ "opacity": 1 });
   //                  }

   //                  zoom_btn_out.children().css({ "opacity": 1 });
   //              }

   //              zoom_btn_out[0].onclick = function (e) {
   //                  zoom = map.getZoom();
   //                  map.setZoom(zoom - 1);

   //                  if (zoom < 12) {
   //                      zoom_btn_out.children().css({ "opacity": .5 });
   //                  } else {
   //                      zoom_btn_out.children().css({ "opacity": 1 });
   //                  }
   //                  zoom_btn_in.children().css({ "opacity": 1 });
   //              }

   //              map.addEventListener('zoomend', function () {
   //                  zoom = map.getZoom();
   //                  listenZoomCtrlChange();
   //              });
   //          }

   //          // 创建控件
   //          var myZoomCtrl = new ZoomControl();

   //          // 添加到地图当中
   //          map.addControl(myZoomCtrl);
   //      });

   //      $(function () {

   //          // 全局状态
   //          var houseListCurPage = 1,
   //              pagesize = 5,
   //              houseListLoadMore = false,
   //              curAreaId,
   //              curZoomLevel = 13,
   //              curLocationPoint,
   //              touchX, touchY, canRenderItemsInPage,
   //              touchButNotLoadTimes = 0, // 统计移动屏幕但没有加载数据的累计次数
   //              alloyTouch = {},
   //              scroller = document.querySelector("#carousel-scroller");

   //          var winWidth = window.innerWidth,
   //              winWidthToComputeImg = winWidth < 450 ? winWidth : 450,
   //              imgWidth = Math.floor(winWidthToComputeImg * .54),
   //              imgHeight = Math.floor(winWidthToComputeImg * .36);

   //          $('#msg').height(imgHeight + 90);

   //          // 城市定位
   //          var cityid = convertCityId(parseURL().params.cityid),
   //              cityName = getCityName(cityid),
   //              hash = parseURL().hash,
   //              cityCenterPoint,
   //              storedRegionData = [];

   //          // DOM对象
   //          var loading = $("#loading"),
   //              allmap_Headers = $(".allmap_Headers"),
   //              allmap_SearchInput = $(".allmap_SearchInput"),
   //              allmap_SearchResult = $(".allmap_SearchResult"),
   //              allmap_SearchRoomList = $(".allmap_SearchRoomList"),
   //              allmap_Location = $(".allmap_Location"),
   //              loadMore = $("#loadMore"),
   //              load_msg = loadMore.find(".msg"),
   //              search_form = $("#allmap_SearchFrom");


   //          // 绑定事件
   //          function bindEvents() {

   //              // submit
   //              search_form.on('submit', function (e) {
   //                  allmap_Headers.removeClass("searching");
   //                  allmap_SearchResult.removeClass("searching");

   //                  e.preventDefault();
   //              });

   //              // 触发搜索
   //              allmap_SearchInput.on("click", function () {
   //                  $(this).focus();
   //                  allmap_Headers.addClass("searching");
   //                  allmap_SearchResult.addClass("searching");

   //                  allmap_SearchRoomList.removeClass("searching");

   //                  // 读取搜索历史
   //                  getSearchHistory();
   //              }).on("search", function (e) {
   //                  var v = $(this).val();

   //                  actionMapSearch(v);
   //                  $(this).blur();
   //              });

   //              // 取消搜索
   //              $(".close_btn").on("click", function () {
   //                  allmap_Headers.removeClass("searching");
   //                  allmap_SearchResult.removeClass("searching");
   //              });

   //              // 搜索历史记录
   //              $(".allmap_SearchResult .history").on("click", ".item", function () {
   //                  var v = $(this).text();

   //                  allmap_SearchInput.val(v);
   //                  actionMapSearch(v);
   //              });

   //              // 取消房源搜索, 状态变为地图找房
   //              $("body").on("touchend", ".BMap_mask", function () {
   //                  $(".loadComunity.active").removeClass("active");
   //                  allmap_SearchRoomList.removeClass("searching");
   //              });

   //              // 拖拽事件，搜索小区时触发
   //              map.addEventListener("dragend", function (e) {
   //                  var zoom = this.getZoom();
   //                  var centerPoint = map.getCenter();

   //                  hashUrlMapStatus(centerPoint, zoom);

   //                  // 移动一定的距离再触发加载 屏幕宽度的.2倍,并使用touchButNotLoadTimes来确保正常加载
   //                  if (Math.abs(touchX - e.offsetX) > winWidth * .2 || Math.abs(touchY - e.offsetY) > winWidth * .2 || touchButNotLoadTimes > 4) {
   //                      var bounds = getBounds();

   //                      touchButNotLoadTimes = 0;

   //                      if (zoom >= 14) {
   //                          loadComunityToMap(bounds);
   //                      }
   //                  } else {
   //                      touchButNotLoadTimes++;
   //                  }
   //              });

   //              // 后退操作, 根据地图缩放级别来确定
   //              $(".back_btn").on("click", function () {
   //                  var zoom = map.getZoom();
   //                  hashUrlMapStatus(map.getCenter(), zoom);

   //                  if (zoom >= 15) {

   //                      // 显示商圈
   //                      if (curAreaId) {
   //                          loadAreaToMap(curAreaId);
   //                      } else {
   //                          loadRegionsToMap(12);
   //                      }
   //                  } else {
   //                      if (zoom < 15 && zoom >= 13) {

   //                          // 显示区域
   //                          loadRegionsToMap(12);
   //                      } else {

   //                          // 跳转到首页
   //                          // 如果是从全民经纪人(link)过来的就返回全民经纪人首页，不然就返回M站首页
   //                          var params = parseURL(location.href).params.origin;
   //                          if (params) {
   //                              var refer = params == 'link' ? 'link' : 'link/shareList';
   //                              window.location.href = "/" + refer + "/?cityId=" + (Cookie('cityid') || cityid);
   //                          } else {
   //                              window.location.href = "/?cityId=" + (Cookie('cityid') || cityid);
   //                          }
                            
   //                      }
   //                  }
   //                  allmap_SearchRoomList.removeClass("searching");
   //              });

   //              // 缩放事件
   //              map.addEventListener("zoomend", function () {
   //                  var zoom = this.getZoom();
   //                  hashUrlMapStatus(map.getCenter(), zoom);

   //                  if (zoom < 13) {

   //                      // 显示区域
   //                      loadRegionsToMap();
   //                  } else {
   //                      if (zoom >= 15) {

   //                          // 显示小区
   //                          var bounds = getBounds();
   //                          loadComunityToMap(bounds);
   //                      }
   //                  }

   //                  allmap_SearchRoomList.removeClass("searching");
   //              });

   //              // 定位
   //              allmap_Location.on("click", function () {
   //                  setLocation();
   //                  allmap_SearchRoomList.removeClass("searching");
   //              });

   //              // 刷新的时候触发定位
   //              if (LocalData.isStorageSupportedFlag && window.location.hash == SessionData.get("curMapHash") && !window.location.search) {
   //                  allmap_Location.trigger("click");
   //              }

   //              map.addEventListener("touchstart", function (e) {
   //                  touchX = e.changedTouches[0].clientX;
   //                  touchY = e.changedTouches[0].clientY;
   //              });

   //              // 房源列表加载
   //              Transform(scroller, true);

   //              function bindAlloyTouch() {
   //                  var min = 0;
   //                  var gap;

   //                  var options = {
   //                      touch: "#carousel-container",
   //                      vertical: false,
   //                      target: scroller,
   //                      property: "translateX",
   //                      bindSelf: false,
   //                      sensitivity: .8,
   //                      min: 0,
   //                      max: 0,
   //                      touchStart: function (e) {
   //                          if (canRenderItemsInPage) {
   //                              min = this.min = 0;
   //                          } else {
   //                              min = this.min = -1 * ((imgWidth + 16) * $(".carousel-scroller .item").length) + winWidth - 40;
   //                              this.max = 0;
   //                          }
   //                      },
   //                      touchEnd: function (evt, value) {
   //                          if (value < min - 50) {

   //                              // 房源翻页
   //                              if (houseListLoadMore) {
   //                                  loadHouseList(allmap_SearchRoomList.attr("data-curcommunity"), function (itemLength) {
   //                                      if (houseListCurPage * pagesize < itemLength) {
   //                                          houseListCurPage++;
   //                                          houseListLoadMore = true;
   //                                          load_msg.text("加载更多");
   //                                      } else {
   //                                          houseListLoadMore = false;
   //                                          load_msg.text("没有更多啦");
   //                                      }
   //                                      loadMore.hide();
   //                                  });
   //                              }
   //                          }
   //                      },
   //                      pressMove: function (evt, value) {
   //                          if (houseListLoadMore) {
   //                              if (value < min - 70) {
   //                                  load_msg.text("加载中");
   //                              }
   //                          } else {
   //                              load_msg.text("没有更多啦");
   //                          }
   //                      },
   //                      animationEnd: function (value) {
   //                          $("#load-mask").width(0);

   //                          if (min > -1 * ((imgWidth + 16) * $(".carousel-scroller .item").length) + winWidth - 40) {
   //                              loadMore.hide();
   //                          }
   //                      },
   //                      change: function (value) {
   //                          value = Math.floor(value);

   //                          // 连续触发
   //                          if (value < min) {
   //                              gap = (min - value) > 150 ? 150 : (min - value);
   //                              gap *= 2.5;
   //                          }
   //                          var gap1 = gap / 100;
   //                          var gap2 = 30 + value < 0 ? 0 : 30 + value;

   //                          if (canRenderItemsInPage) {
   //                              loadMore.css({
   //                                  "-webkit-transform": "translate3d(" + gap2 + "px, 0, 0)",
   //                                  "transform": "translate3d(" + gap2 + "px, 0, 0)"
   //                              });
   //                              loadMore.show();
   //                          } else {
   //                              if (gap1 < 0.002) {
   //                                  gap1 = 0;
   //                              }

   //                              $("#load-mask").css({
   //                                  "top": -gap1 + "%",
   //                                  "bottom": -gap1 + "%",
   //                                  "left": -6 * gap1 + "px",
   //                                  "clip": "rect(0, " + 6 * gap1 + "px, auto, auto)",
   //                                  "width": 12 * gap1 + "px"
   //                              });

   //                              if (value <= min + 20) {
   //                                  loadMore.css({
   //                                      "-webkit-transform": "translate3d(" + gap2 + "px, 0, 0)",
   //                                      "transform": "translate3d(" + gap2 + "px, 0, 0)"
   //                                  });

   //                                  loadMore.show();
   //                              } else {
   //                                  loadMore.css({
   //                                      "-webkit-transform": "translate3d(0, 0, 0)",
   //                                      "transform": "translate3d(0, 0, 0)"
   //                                  });

   //                                  loadMore.hide();
   //                              }
   //                          }
   //                      },
   //                      tap: function (evt, value) {

   //                          // 跳转到详情页
   //                          var $that = $(evt.target).parents(".item");
   //                          var houseId = $that.data("houseid"), roomId = $that.data('roomid');
   //                          if (houseId && roomId) {
   //                              if (LocalData.isStorageSupportedFlag) {
   //                                  SessionData.remove("curMapHash");
   //                              }
   //                              window.location.href = "/room/" + houseId + '/' + roomId;
   //                          }
   //                      }
   //                  };

   //                  return new AlloyTouch(options);
   //              }

   //              alloyTouch = bindAlloyTouch();
   //          }

   //          // 响应关键字搜索
   //          function actionMapSearch(keyword) {
   //              allmap_Headers.removeClass("searching");
   //              allmap_SearchResult.removeClass("searching");
   //              allmap_SearchRoomList.removeClass("searching");

   //              // 百度智能搜索
   //              var local = new BMap.LocalSearch(map, {
   //                  onSearchComplete: function myFun() {
   //                      var posi = local.getResults().getPoi(0);     // 获取第一个搜索结果
   //                      var pp;

   //                      if (posi) {

   //                          // 搜索结果属于当前城市
   //                          if (posi.city.indexOf(cityName) >= 0) {

   //                              // 获取搜索结果的中心定位点
   //                              pp = posi.point;
   //                              loadComunityToMap(null, pp, keyword);
   //                              hashUrlMapStatus(pp, 15);
   //                          }
   //                      }
   //                  }
   //              });

   //              local.search(keyword);
   //          }

   //          // 保存搜索历史
   //          function setSearchHistory(v) {
   //              var localHistory = LocalData.get("search" + cityid);

   //              if (localHistory) {
   //                  var arr = localHistory.split(",");
   //                  var len = arr.length;

   //                  for (var i = 0; i < len; i++) {
   //                      if (v == arr[i]) {
   //                          break;
   //                      } else {
   //                          if (i == len - 1) {
   //                              LocalData.set("search" + cityid, localHistory + "," + v);
   //                          }
   //                      }
   //                  }
   //              } else {
   //                  LocalData.set("search" + cityid, v);
   //              }
   //          }

   //          // 加载搜索历史
   //          function getSearchHistory(v) {
   //              var localHistory;
   //              var history = $("#history").empty();

   //              if (LocalData.isStorageSupportedFlag) {
   //                  localHistory = LocalData.get("search" + cityid);
   //              }

   //              if (localHistory) {
   //                  var arr = localHistory.split(",").reverse();
   //                  var len = arr.length;

   //                  for (var i = 0; i < len; i++) {
   //                      history.append('<div class="item">' + arr[i] + '</div>')
   //                  }
   //              } else {
   //                  history.append("<div>暂无历史记录</div>");
   //              }
   //          }

   //          // 保存地图中心位置和zoom，可通过url直接定位
   //          function hashUrlMapStatus(curPoint, curLevel) {
   //              window.location.hash = curPoint.lng + "," + curPoint.lat + "," + curLevel;

   //              if (LocalData.isStorageSupportedFlag) {
   //                  SessionData.set("curMapHash", "#" + curPoint.lng + "," + curPoint.lat + "," + curLevel);
   //              }
   //          }

   //          // 获取定位
   //          function getLocation(cbk) {
   //              var d = new BMap.Geolocation();
   //              d.getCurrentPosition(function (r) {
   //                  if (this.getStatus() == BMAP_STATUS_SUCCESS) {
   //                      curLocationPoint = r.point;
   //                      cbk ? cbk(r.point) : null;

   //                      var geo = new BMap.Geocoder();
   //                      geo.getLocation(r.point, function (q) {
   //                          var mapCityName = q.addressComponents.city;

   //                          // 重置地图城市位置
   //                          cityid = getCityId(mapCityName);
   //                          cityName = getCityName(cityid);
   //                          //微信直接进入页面加上城市
   //                          window.location.search = "cityid=" + cityid;
   //                      });
   //                  }
   //                  else {
   //                      alert("无法定位哦~");
   //                      allmap_Location.removeClass("settinglocation");
   //                  }
   //              }, { enableHighAccuracy: true });
   //          }

   //          // 设置marker
   //          function setLocationMarker() {
   //              if (curLocationPoint) {
   //                  var marker = new BMap.Marker(curLocationPoint);

   //                  map.addOverlay(marker);
   //              }
   //          }

   //          // 设置定位
   //          function setLocation() {
   //              allmap_Location.addClass("settinglocation");

   //              var t = setTimeout(function () {
   //                  allmap_Location.removeClass("settinglocation");
   //              }, 10000);

   //              getLocation(function (point) {
   //                  clearTimeout(t);
   //                  $(".BMap_Marker").remove();

   //                  var marker = new BMap.Marker(point);
   //                  map.addOverlay(marker);

   //                  map.setCenter(point);
   //                  allmap_Location.removeClass("settinglocation");

   //                  var zoom = map.getZoom();
   //                  var bounds = getBounds();

   //                  if (zoom > 14) {
   //                      // 显示小区
   //                      loadComunityToMap(bounds);
   //                  }
   //              });
   //          }

   //          // 封装ajax对象
   //          var changeAjax = {
   //              _get: function (url, param, success, error) {
   //                  this._ajax('get', url, param, success, error);
   //              },
   //              _post: function (url, param, success, error) {
   //                  this._ajax('post', url, param, success, error);
   //              },
   //              _ajax: function (type, url, param, success, error) {
   //                  loading.show();
   //                  var d1 = new Date();
   //                  var t = setTimeout(function () {
   //                      loading.hide();
   //                  }, 10000);

   //                  var options = {
   //                      url: url,
   //                      type: type || get,
   //                      data: param,
   //                      dataType: 'json',
   //                      success: success,
   //                      error: error,
   //                      complete: function () {
   //                          var d2 = new Date();

   //                          if (d2 - d1 < 500) {
   //                              setTimeout(function () {
   //                                  loading.hide();
   //                              }, 500);
   //                          } else {
   //                              loading.hide();
   //                          }

   //                          clearTimeout(t);
   //                      }
   //                  }

   //                  $.ajax(options);
   //              },

   //              GetRegions: function (success) {
   //                  this._get('/room/regions/' + cityid, null, success);
   //              },
   //              GetSubarea: function (areaid, success) {
   //                  this._get('/room/subarea/' + cityid + "/" + areaid, null, success);
   //              },
   //              GetCommunity: function (param, success) {
   //                  this._get('/room/mapcommunity?page=1&pagesize=1000&cityid=' + cityid, param, success);
   //              },
   //              GetHouseList: function (param, success) {
   //                  this._get('/room/maprooms?cityid=' + cityid, param, success);
   //              }
   //          }

   //          // 获取可视区域的坐标
   //          function getBounds() {
   //              var bs = map.getBounds();
   //              var bssw = bs.getSouthWest();
   //              var bsne = bs.getNorthEast();

   //              var searchBounds = {
   //                  "latbegin": bssw.lat,
   //                  "latend": bsne.lat,
   //                  "lngbegin": bssw.lng,
   //                  "lngend": bsne.lng
   //              }


   //              return searchBounds;
   //          }


   //          // ======================
   //          // 行政区县 / 商圈覆盖物
   //          function RegionOverlay(data) {
   //              this._text = data.Name;
   //              this._Lat = data.Lat;
   //              this._Lng = data.Lng;
   //              this._Count = data.Count;
   //          }

   //          RegionOverlay.prototype = new BMap.Overlay();

   //          //创建地图的覆盖物节点
   //          RegionOverlay.prototype.initialize = function (map) {
   //              this._map = map;
   //              var div = this.div = $('<div class="loadMap">');

   //              div.css("zIndex", BMap.Overlay.getZIndex(this._Lat));

   //              div.attr("data-load-lng", this._Lng);
   //              div.attr("data-load-lat", this._Lat);

   //              $('<div class="region-name">' + this._text + '</div>').appendTo($(div));

   //              // 给覆盖物添加事件
   //              map.getPanes().labelPane.appendChild(div[0]);
   //              return div[0];
   //          }

   //          // 绘制地图
   //          RegionOverlay.prototype.draw = function () {
   //              var point = new BMap.Point(this._Lng, this._Lat);
   //              var position = this._map.pointToOverlayPixel(point);
   //              this.div.css("left", position.x - 30 + "px");
   //              this.div.css("top", position.y - 50 + "px");
   //          }

   //          // ========================
   //          // 楼盘覆盖物
   //          function ComunityOverlay(options) {
   //              this.o = {
   //                  Id: '',
   //                  Name: '',
   //                  Lng: '',
   //                  Lat: '',
   //                  Address: "",
   //                  MinRental: "",
   //                  MaxRental: "",
   //                  RoomCount: ''
   //              }

   //              for (var i in options) {
   //                  this.o[i] = options[i];
   //              }
   //          }

   //          ComunityOverlay.prototype = new BMap.Overlay();

   //          ComunityOverlay.prototype.initialize = function (map) {
   //              this._map = map;
   //              var wrapDiv = this._wrapDiv = document.createElement("div");
   //              $(wrapDiv).attr("class", "loadComunity");
   //              wrapDiv.style.position = "absolute";
   //              wrapDiv.setAttribute("data-load-lng", this.o.Lng);
   //              wrapDiv.setAttribute("data-load-lat", this.o.Lat);

   //              var box = document.createElement("div");
   //              box.setAttribute('class', 'box');

   //              var name = document.createElement("div");
   //              name.setAttribute('class', 'name');

   //              var span1 = document.createElement("span");
   //              span1.appendChild(document.createTextNode(this.o.Name));

   //              var span2 = document.createElement("span");
   //              span2.appendChild(document.createTextNode(this.o.RoomCount));
   //              span2.setAttribute('class', 'room-count');

   //              name.appendChild(span1);
   //              name.appendChild(span2);


   //              var jiantou = document.createElement("div");
   //              jiantou.setAttribute('class', 'jiantou iconfont icon-shape');

   //              box.appendChild(name);
   //              box.appendChild(jiantou);
   //              wrapDiv.appendChild(box);

   //              map.getPanes().labelPane.appendChild(wrapDiv);
   //              return wrapDiv;
   //          }

   //          ComunityOverlay.prototype.draw = function () {
   //              var point = new BMap.Point(this.o.Lng, this.o.Lat);
   //              var position = this._map.pointToOverlayPixel(point);
   //              var offsetLeft = this._wrapDiv.offsetWidth / 2;

   //              this._wrapDiv.style.left = position.x - offsetLeft + "px";
   //              this._wrapDiv.style.top = position.y - 53 + "px";
   //          }

   //          // 加载区域
   //          function loadRegionsToMap(zoomLevel) {
   //              map.clearOverlays();
   //              setLocationMarker();

   //              zoomLevel ? zoomLevel : null;
   //              map.centerAndZoom(cityCenterPoint, zoomLevel);

   //              for (var i = 0; i < storedRegionData.length; i++) {
   //                  var regionsOverlay = new RegionOverlay(storedRegionData[i]);

   //                  map.addOverlay(regionsOverlay);
   //                  $(regionsOverlay.div).attr("data-areaid", storedRegionData[i].AreaId);

   //                  $(regionsOverlay.div).on("touchend", function (e) {

   //                      // touch移动的时候不加载房源列表
   //                      if (Math.abs(touchX - e.changedTouches[0].clientX) > 15 || Math.abs(touchY - e.changedTouches[0].clientY) > 15) {
   //                          return;
   //                      }

   //                      var lng = $(this).attr("data-load-lng");
   //                      var lat = $(this).attr("data-load-lat");
   //                      var areaid = $(this).attr("data-areaid");

   //                      var point = new BMap.Point(lng, lat);

   //                      curAreaId = areaid;
   //                      loadAreaToMap(areaid, point);
   //                  });
   //              }
   //          }

   //          // 加载商圈
   //          function loadAreaToMap(areaid, point) {
   //              map.clearOverlays();
   //              setLocationMarker();

   //              if (!point) {

   //                  //获取商圈中心位置
   //                  for (var j = 0; j < storedRegionData.length; j++) {
   //                      if (areaid == storedRegionData[j].AreaId) {
   //                          point = new BMap.Point(storedRegionData[j].Lng, storedRegionData[j].Lat);
   //                      }
   //                  }
   //              }
   //              map.centerAndZoom(point, 13);

   //              changeAjax.GetSubarea(areaid, function (data) {
   //                  var dd = data;
   //                  var data = dd.data;

   //                  for (var i = 0; i < data.length; i++) {
   //                      var regionsOverlay = new RegionOverlay(data[i]);

   //                      map.addOverlay(regionsOverlay);
   //                      $(regionsOverlay.div).on("touchend", function (e) {

   //                          // touch移动的时候不加载房源列表
   //                          if (Math.abs(touchX - e.changedTouches[0].clientX) > 15 || Math.abs(touchY - e.changedTouches[0].clientY) > 15) {
   //                              return;
   //                          }

   //                          var lng = $(this).attr("data-load-lng");
   //                          var lat = $(this).attr("data-load-lat");
   //                          var point = new BMap.Point(lng, lat);

   //                          map.centerAndZoom(point, 15);
   //                          var bounds = getBounds();

   //                          loadComunityToMap(bounds);
   //                      });
   //                  }
   //              });
   //          }

   //          // 加载小区
   //          function loadComunityToMap(bounds, centerPoint, searchKeyword) {

   //              // 有些情况根据centerpoint来计算bounds
   //              if (centerPoint) {
   //                  map.panTo(centerPoint);
   //                  bounds = getBounds();
   //              }

   //              changeAjax.GetCommunity(bounds, function (data) {
   //                  var dd = data;
   //                  data = dd.data;

   //                  map.clearOverlays();
   //                  setLocationMarker();

   //                  if (data.length) {

   //                      // 只存储有记录的搜索结果
   //                      if (LocalData.isStorageSupportedFlag && searchKeyword) {
   //                          setSearchHistory(searchKeyword);
   //                      }

   //                      for (var i = 0; i < data.length; i++) {
   //                          if (i == 0) {
   //                              curAreaId = data[0].AreaID;
   //                          }

   //                          var comunityOverlay = new ComunityOverlay(data[i]);

   //                          map.addOverlay(comunityOverlay);
   //                          $(comunityOverlay._wrapDiv).attr("data-communityId", data[i].Id);

   //                          $(comunityOverlay._wrapDiv).on("touchend", function (e) {

   //                              // touch移动的时候不加载房源列表
   //                              if (Math.abs(touchX - e.changedTouches[0].clientX) > 15 || Math.abs(touchY - e.changedTouches[0].clientY) > 15) {
   //                                  allmap_SearchRoomList.removeClass("searching");
   //                                  return;
   //                              }

   //                              var lng = $(this).attr("data-load-lng");
   //                              var lat = $(this).attr("data-load-lat");
   //                              var communityId = $(this).attr("data-communityId");

   //                              var zoom = map.zoomLevel > 15 ? map.zoomLevel : 15;
   //                              var point = new BMap.Point(lng, lat - .004 * (1 - (zoom - 15) / 3)); // para向上偏移
   //                              map.centerAndZoom(point, zoom);

   //                              $(this).addClass("active").siblings().removeClass("active");
   //                              allmap_SearchRoomList.addClass("searching");

   //                              var curCommunity = allmap_SearchRoomList.attr("data-curcommunity") || "";

   //                              // 切换小区
   //                              if (curCommunity != communityId) {

   //                                  // 列表搜索状态恢复
   //                                  houseListCurPage = 1;
   //                                  houseListLoadMore = true;

   //                                  allmap_SearchRoomList.attr("data-curcommunity", communityId);
   //                                  allmap_SearchRoomList.find(".wrap").empty();
   //                                  load_msg.text("加载更多");
   //                                  loadMore.hide();

   //                                  // 滚动到初始位置
   //                                  scroller.translateX = 0;

   //                                  loadHouseList(communityId, function (itemLength) {
   //                                      houseListCurPage++;

   //                                      if (itemLength <= pagesize) {
   //                                          houseListLoadMore = false;
   //                                          load_msg.text("没有更多啦");
   //                                      }
   //                                  });
   //                              }
   //                          });
   //                      }
   //                  }
   //              });
   //          }

   //          // 加载房源
   //          function loadHouseList(communityId, cbk) {
   //              var param = {
   //                  "CommunityId": communityId,
   //                  "page": houseListCurPage,
   //                  "pagesize": pagesize
   //              };

   //              $("#load-mask").css("width", 0);

   //              changeAjax.GetHouseList(param, function (data) {
   //                  var rooms = data.data.Rooms;
   //                  var wrap = [];
   //                  var accessory = {
   //                      "HasToilet": "独卫",
   //                      "HasWindow": "飘窗",
   //                      "HasBalcony": "阳台",
   //                      "HasLiveTwoPeople": "可住两人",
   //                      "HasDoubleBed": "可住两人",
   //                      "HasAir": "空调",
   //                      "HasAirPosition": "可装空调",
   //                      "HasSmartlock": "智能门锁",
   //                  };

   //                  if (rooms) {
   //                      for (var i = 0; i < rooms.length; i++) {
   //                          var n = 0;

   //                          var item = '<div class="item" style="width:' + imgWidth + 'px; height:' + (imgHeight + 90) + 'px" data-houseid="' + rooms[i].HouseId + '"data-roomid="' + rooms[i].RoomId +'">' +
   //                                  '<div class="photo"><img style="width=' + imgWidth + 'px; height:' + imgHeight + 'px" src="' + rooms[i].ImageUrl + '?imageView2/1/w/' + imgWidth + '/h/' + imgHeight + '"></div>' +
   //                                  '<div class="detail">' +
   //                                      '<div class="room">' + rooms[i].ShowTitle + '</div>' +
   //                                      '<div class="price"><span class="rmb">¥</span>' + rooms[i].RentAmount + '<span class="unit">元/月</span></div>';


   //                          if (rooms[i].HouseType == 1) {
   //                              item += '<div class="tag hz-tag"><span class="house-type">合</span>';
   //                          } else if (rooms[i].HouseType == 0) {
   //                              item += '<div class="tag zz-tag"><span class="house-type">整</span>';
   //                          }

   //                          // 读取配套设施
   //                          for (var j in accessory) {
   //                              if (rooms[i][j] && n < 4) {
   //                                  n++;
   //                                  item += '<span>' + accessory[j] + '</span>';
   //                              }
   //                          }

   //                          item += '</div>' +
   //                              '</div>' +
   //                              '</div>';

   //                          if (n < 4) {
   //                              item = item.replace(/class="tag/, 'class="tag tag-less');
   //                          }

   //                          wrap.push(item);
   //                      }

   //                      var itemNum = (houseListCurPage - 1) * pagesize + rooms.length;

   //                      if (itemNum * (imgWidth + 16) < winWidth) {
   //                          canRenderItemsInPage = true;
   //                      } else {
   //                          canRenderItemsInPage = false;
   //                      }

   //                      $(".allmap_SearchRoomList .wrap").append($(wrap.join("")));

   //                      setTimeout(function () {
   //                          loadMore.hide();
   //                      }, 500);
   //                  }

   //                  cbk ? cbk(data.data.RoomCount) : null;
   //              });
   //          }

   //          // 初始化
   //          function init() {

   //              // 获取并保存regions数据
   //              changeAjax.GetRegions(function (data) {
   //                  var dd = data;
   //                  var data = dd.data;

   //                  storedRegionData = data;
   //                  bindEvents();

   //                  if (hash) {

   //                      // 根据url保存的坐标和zoom值定位
   //                      hash = hash.split(",");
   //                      var point = {
   //                          "lng": hash[0],
   //                          "lat": hash[1]
   //                      };
   //                      var zoom = hash[2];

   //                      if (zoom == 13) {
   //                          zoom = 12;
   //                      }

   //                      cityCenterPoint = new BMap.Point(point.lng, point.lat);
   //                      map.centerAndZoom(cityCenterPoint, zoom);
   //                  } else {

   //                      // 根据城市名，使用百度智能搜索设置中心点坐标，并显示区域
   //                      var myGeo = new BMap.Geocoder();
   //                      myGeo.getPoint(cityName, function (point) {
   //                          cityCenterPoint = new BMap.Point(point.lng, point.lat); // 创建点坐标

   //                          if (cityid == '38') {
   //                              map.centerAndZoom(cityCenterPoint, 10);
   //                              return;
   //                          }
   //                          map.centerAndZoom(cityCenterPoint, 12);
   //                      });

   //                  }

   //                  loading.hide();
   //              });
   //          }

   //          init();
   //      });

</script>
</body>
</html>